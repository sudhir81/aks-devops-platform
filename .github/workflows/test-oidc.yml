name: üîê Test OIDC Azure Login

on:
  workflow_dispatch:

permissions:
  id-token: write        # Required for OIDC authentication
  contents: read

jobs:
  verify:
    name: Verify OIDC Authentication
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Step 1. Checkout Code
      # -----------------------------
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      # -----------------------------
      # Step 2. Login to Azure using OIDC
      # -----------------------------
      - name: üîê Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

      # -----------------------------
      # Step 3. Verify Azure Context
      # -----------------------------
      - name: üß© Show Azure Context
        run: |
          echo "=== Azure Subscription Context ==="
          az account show --output jsonc

      # -----------------------------
      # Step 4. Verify Current Identity
      # -----------------------------
      - name: üë§ Verify Azure Identity
        run: |
          echo "üîç Checking current signed-in identity..."
          az ad signed-in-user show --query "{displayName:displayName, id:id, userPrincipalName:userPrincipalName}" -o jsonc || \
          echo "‚ö†Ô∏è This identity is a Service Principal (expected for OIDC GitHub Actions)"
