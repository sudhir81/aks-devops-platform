name: üöÄ AKS DevOps Platform CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  id-token: write   # ‚úÖ Required for Azure OIDC login
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: sample-app
      CHART_PATH: charts/sample-app
      RELEASE_NAME: sample-app
      K8S_NAMESPACE: default
      ENV_PATH: envs/dev

    steps:
      # -----------------------------
      # Checkout Code
      # -----------------------------
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      # -----------------------------
      # Validate Required Secrets (Static, Safe)
      # -----------------------------
      - name: üß† Validate Required Secrets
        run: |
          echo "üîç Validating required secrets..."
          MISSING=false

          check_secret() {
            if [ -z "$1" ]; then
              echo "‚ùå Missing secret: $2"
              MISSING=true
            else
              echo "‚úÖ $2 found"
            fi
          }

          check_secret "${{ secrets.AZURE_CLIENT_ID }}" "AZURE_CLIENT_ID"
          check_secret "${{ secrets.AZURE_TENANT_ID }}" "AZURE_TENANT_ID"
          check_secret "${{ secrets.AZURE_SUBSCRIPTION_ID }}" "AZURE_SUBSCRIPTION_ID"
          check_secret "${{ secrets.ACR_NAME }}" "ACR_NAME"
          check_secret "${{ secrets.AKS_CLUSTER_NAME }}" "AKS_CLUSTER_NAME"
          check_secret "${{ secrets.AKS_RESOURCE_GROUP }}" "AKS_RESOURCE_GROUP"

          if [ "$MISSING" = true ]; then
            echo "‚ùå One or more required secrets are missing. Exiting..."
            exit 1
          fi
          echo "‚úÖ All required secrets are present."

      # -----------------------------
      # Azure Login via OIDC
      # -----------------------------
      - name: üîê Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # -----------------------------
      # Validate & Ensure Role Assignments (Self-Healing)
      # -----------------------------
      - name: üîë Validate Azure Role Assignments
        run: |
          echo "üîç Validating AKS and Storage permissions for GitHub OIDC App..."
          SP_ID=${{ secrets.AZURE_CLIENT_ID }}
          SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}
          RG_NAME=${{ secrets.AKS_RESOURCE_GROUP }}
          AKS_NAME=${{ secrets.AKS_CLUSTER_NAME }}

          # Get AKS resource ID
          AKS_ID=$(az aks show --name "$AKS_NAME" --resource-group "$RG_NAME" --query id -o tsv)
          echo "üß© AKS Resource ID: $AKS_ID"

          # ‚úÖ Check AKS access
          ROLE_EXISTS=$(az role assignment list \
            --assignee "$SP_ID" \
            --scope "$AKS_ID" \
            --query "[?roleDefinitionName=='Azure Kubernetes Service Cluster User Role'] | length(@)" -o tsv)

          if [ "$ROLE_EXISTS" -eq 0 ]; then
            echo "‚ö†Ô∏è Missing AKS Cluster User Role ‚Äî assigning..."
            az role assignment create \
              --assignee "$SP_ID" \
              --role "Azure Kubernetes Service Cluster User Role" \
              --scope "$AKS_ID"
            echo "‚úÖ AKS role assignment added."
          else
            echo "‚úÖ AKS role already assigned."
          fi

          # ‚úÖ Check Terraform backend (Storage Blob Data Contributor)
          echo "üîç Checking Terraform state storage permissions..."
          STORAGE_SCOPE=$(az storage account list --resource-group rg-landingzone-tfstate --query "[0].id" -o tsv)
          ROLE_EXISTS=$(az role assignment list \
            --assignee "$SP_ID" \
            --scope "$STORAGE_SCOPE" \
            --query "[?roleDefinitionName=='Storage Blob Data Contributor'] | length(@)" -o tsv)

          if [ "$ROLE_EXISTS" -eq 0 ]; then
            echo "‚ö†Ô∏è Missing Storage Blob Data Contributor ‚Äî assigning..."
            az role assignment create \
              --assignee "$SP_ID" \
              --role "Storage Blob Data Contributor" \
              --scope "$STORAGE_SCOPE"
            echo "‚úÖ Storage role assignment added."
          else
            echo "‚úÖ Storage access already assigned."
          fi

      # -----------------------------
      # Setup Terraform
      # -----------------------------
      - name: üß± Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      # -----------------------------
      # Terraform Init / Plan
      # -----------------------------
      - name: ‚öôÔ∏è Terraform Init
        run: terraform -chdir=${{ env.ENV_PATH }} init -input=false
        env:
          ARM_USE_OIDC: true
          ARM_SKIP_CLI_CREDENTIAL: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: üßÆ Terraform Plan
        run: terraform -chdir=${{ env.ENV_PATH }} plan -input=false -out=tfplan -var-file=dev.tfvars
        env:
          ARM_USE_OIDC: true
          ARM_SKIP_CLI_CREDENTIAL: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # -----------------------------
      # Build & Push Docker Image
      # -----------------------------
      - name: üê≥ Azure Container Registry Login
        run: az acr login --name ${{ secrets.ACR_NAME }}
          
      - name: üèóÔ∏è Build and Push Docker Image
        run: |
          echo "üîß Building Docker image..."
          docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          echo "üì¶ Pushing image to ACR..."
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

      # -----------------------------
      # Connect to AKS
      # -----------------------------
      - name: üéØ Get AKS Credentials
        env:
          AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
          AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
        run: |
          echo "üîê Connecting to AKS..."
          echo "Using cluster: $AKS_CLUSTER_NAME"
          echo "Using resource group: $AKS_RESOURCE_GROUP"
          az aks get-credentials \
            --name "$AKS_CLUSTER_NAME" \
            --resource-group "$AKS_RESOURCE_GROUP" \
            --overwrite-existing

      # -----------------------------
      # Verify AKS Connection
      # -----------------------------
      - name: üîç Verify AKS Context
        run: |
          echo "üîπ Current context:"
          kubectl config current-context || echo "‚ö†Ô∏è No context found"
          echo "üîπ Checking AKS nodes:"
          kubectl get nodes || echo "‚ö†Ô∏è AKS not reachable"
      
      # -----------------------------
      # Helm Deploy
      # -----------------------------
      - name: ‚õµ Deploy via Helm
        run: |
          echo "üöÄ Deploying Helm release..."
          helm upgrade --install $RELEASE_NAME $CHART_PATH \
            --namespace $K8S_NAMESPACE \
            --set image.repository=${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }} \
            --set image.tag=latest \
            --wait
          echo "‚úÖ Helm deployment complete!"

      # -----------------------------
      # ‚úÖ Deployment Summary
      # -----------------------------
      - name: ‚úÖ Deployment Summary
        run: |
          echo "Deployment complete!"
          echo "Fetching service details..."
          kubectl get svc -n $K8S_NAMESPACE
          
          echo "‚è≥ Waiting for external IP..."
          for i in {1..20}; do
            EXTERNAL_IP=$(kubectl get svc -n $K8S_NAMESPACE | grep $RELEASE_NAME | awk '{print $4}')
            if [[ "$EXTERNAL_IP" != "<pending>" && "$EXTERNAL_IP" != "" ]]; then
              echo "üåê App URL: http://$EXTERNAL_IP"
              exit 0
            fi
            echo "Still waiting for external IP... ($i/20)"
            sleep 15
          done
          
          echo "‚ö†Ô∏è External IP not found yet ‚Äî check AKS LoadBalancer status."

