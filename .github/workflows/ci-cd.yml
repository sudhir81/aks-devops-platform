name: üöÄ AKS DevOps Platform CI/CD

on:
  push:
    branches: ["main", "dev"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:   # üëà allows manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: sample-app
      CHART_PATH: charts/sample-app
      RELEASE_NAME: sample-app
      K8S_NAMESPACE: default

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: üì¶ Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Login to Azure using OIDC (no secrets.json!)
      - name: üîê Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 3Ô∏è‚É£ Login to ACR
      - name: üê≥ Azure Container Registry Login
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}

      # 4Ô∏è‚É£ Build and Push Docker Image
      - name: üö¢ Build and Push Image to ACR
        run: |
          IMAGE_TAG=${{ github.sha }}
          ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.ACR_NAME }} --query loginServer -o tsv)
          docker build -t $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:$IMAGE_TAG .
          docker push $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:$IMAGE_TAG

      # 5Ô∏è‚É£ Set AKS Context
      - name: ‚ò∏Ô∏è Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      # 6Ô∏è‚É£ Deploy or Upgrade Helm Chart
      - name: ‚öôÔ∏è Helm Upgrade or Install
        run: |
          ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.ACR_NAME }} --query loginServer -o tsv)
          helm upgrade --install $RELEASE_NAME $CHART_PATH \
            --namespace $K8S_NAMESPACE \
            --create-namespace \
            --set image.repository=$ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.sha }} \
            --wait

